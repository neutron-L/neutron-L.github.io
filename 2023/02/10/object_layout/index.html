<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>c++对象布局 | Keep Love</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Keep Love</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-object_layout" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/02/10/object_layout/" class="article-date">
  <time class="dt-published" datetime="2023-02-10T04:37:37.918Z" itemprop="datePublished">2023-02-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/language/">language</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      c++对象布局
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文讨论c++中的对象内存布局，包括c++对象的数据成员以及为支持多态机制而添加的额外的数据在对象中的分布。</p>
<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p>体系结构：x86_64</p>
<p>操作系统：Ubuntu 22.04 Linux os 6.2.0-36-generic</p>
<p>编译器：gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0</p>
<h2 id="Data-Member的布局"><a href="#Data-Member的布局" class="headerlink" title="Data Member的布局"></a>Data Member的布局</h2><p>Question 1：对象中不同访问类型的成员是怎么分布的？有可能同种访问类型的成员排列在一起，然后按照指定的顺序比如public、protected、private分布，也可能按照声明顺序分布。</p>
<p>编写如下测试程序，类Obj中的数据成员随意声明，检验编译器是否会把同种访问类型的成员安排在相邻的内存位置。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Print</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Print</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">uint8_t</span> b;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">    <span class="type">float</span> d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">short</span> e;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">long</span> f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Print</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">     <span class="function"><span class="type">void</span> <span class="title">printObj</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        Obj obj;                                    <span class="comment">// offset</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj:   &quot;</span> &lt;&lt; &amp;obj &lt;&lt; endl;         <span class="comment">// 0 </span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.a: &quot;</span> &lt;&lt; &amp;obj.a &lt;&lt; endl;       <span class="comment">// 0</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.b: &quot;</span> &lt;&lt; (<span class="type">int</span> *)&amp;obj.b &lt;&lt; endl; <span class="comment">// 4</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.c: &quot;</span> &lt;&lt; &amp;obj.c &lt;&lt; endl;        <span class="comment">// 8</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.d: &quot;</span> &lt;&lt; &amp;obj.d &lt;&lt; endl;        <span class="comment">// 16</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.e: &quot;</span> &lt;&lt; &amp;obj.e &lt;&lt; endl;        <span class="comment">// 20</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.f: &quot;</span> &lt;&lt; &amp;obj.f &lt;&lt; endl;        <span class="comment">// 24</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;sizeof obj: &quot;</span> &lt;&lt; <span class="keyword">sizeof</span> obj &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Print p;</span><br><span class="line">    p.<span class="built_in">printObj</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&amp;obj:   0x7fffd69afeb0</span><br><span class="line">&amp;obj.a: 0x7fffd69afeb0</span><br><span class="line">&amp;obj.b: 0x7fffd69afeb4</span><br><span class="line">&amp;obj.c: 0x7fffd69afeb8</span><br><span class="line">&amp;obj.d: 0x7fffd69afec0</span><br><span class="line">&amp;obj.e: 0x7fffd69afec4</span><br><span class="line">&amp;obj.f: 0x7fffd69afec8</span><br><span class="line">sizeof obj: 32</span><br></pre></td></tr></table></figure>

<p>可见，<strong>数据成员是按照声明顺序排列的</strong>，这一点与c语言中的结构体一致，编译器也不会特意安排不同访问类型的数据成员的前后地址。</p>
<h2 id="继承无多态"><a href="#继承无多态" class="headerlink" title="继承无多态"></a>继承无多态</h2><p>为上述的类Obj添加一个以及两个父类，子类会继承父类的数据成员，查看父类的成员在子类中的分布。</p>
<p>Question 1: 父类的数据成员应该被安排在子类的开头处，如果有多个父类，则按照父类的继承顺序，先安置父类的数据成员，再安置子类的数据成员。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> x2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> y1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> y2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> y3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span> : <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2</span><br><span class="line">.....</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printObj</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj:   &quot;</span> &lt;&lt; &amp;obj &lt;&lt; endl;                <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.x1: &quot;</span> &lt;&lt; &amp;obj.x1 &lt;&lt; endl;            <span class="comment">// 0</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.x2: &quot;</span> &lt;&lt; &amp;obj.x2 &lt;&lt; endl;            <span class="comment">// 4</span></span><br><span class="line">    <span class="comment">// 接下来是x3，但是x3对子类来说无法直接访问</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.y1: &quot;</span> &lt;&lt; &amp;obj.y1 &lt;&lt; endl;            <span class="comment">// 12</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.y2: &quot;</span> &lt;&lt; &amp;obj.y2 &lt;&lt; endl;            <span class="comment">// 16</span></span><br><span class="line">    <span class="comment">// 接下来是y3，但是y3对子类来说无法直接访问</span></span><br><span class="line">    <span class="comment">//然后才是子类自己声明的数据成员</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.a: &quot;</span> &lt;&lt; &amp;obj.a &lt;&lt; endl;               <span class="comment">// 24</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.b: &quot;</span> &lt;&lt; (<span class="type">int</span> *)&amp;obj.b &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.c: &quot;</span> &lt;&lt; &amp;obj.c &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.d: &quot;</span> &lt;&lt; &amp;obj.d &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.e: &quot;</span> &lt;&lt; &amp;obj.e &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&amp;obj.f: &quot;</span> &lt;&lt; &amp;obj.f &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;sizeof obj: &quot;</span> &lt;&lt; <span class="keyword">sizeof</span> obj &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&amp;obj:   0x7fffe0548610</span><br><span class="line">&amp;obj.x1: 0x7fffe0548610</span><br><span class="line">&amp;obj.x2: 0x7fffe0548614</span><br><span class="line">&amp;obj.y1: 0x7fffe054861c</span><br><span class="line">&amp;obj.y2: 0x7fffe0548620</span><br><span class="line">&amp;obj.a: 0x7fffe0548628</span><br><span class="line">&amp;obj.b: 0x7fffe054862c</span><br><span class="line">&amp;obj.c: 0x7fffe0548630</span><br><span class="line">&amp;obj.d: 0x7fffe0548638</span><br><span class="line">&amp;obj.e: 0x7fffe054863c</span><br><span class="line">&amp;obj.f: 0x7fffe0548640</span><br><span class="line">sizeof obj: 56</span><br></pre></td></tr></table></figure>

<p>可见，编译器确实会按照继承的顺序安排父类的数据成员。</p>
<h2 id="加上多态——单继承"><a href="#加上多态——单继承" class="headerlink" title="加上多态——单继承"></a>加上多态——单继承</h2><p>修改程序，给Base1加上虚函数，Obj仅继承自Base1：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x1;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> x2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x3;</span><br><span class="line">&#125;;</span><br><span class="line">....</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span> : <span class="keyword">public</span> Base1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Print</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">uint8_t</span> b;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">    <span class="type">float</span> d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">short</span> e;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">long</span> f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Print</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">printObj</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Obj obj;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj:   &quot;</span> &lt;&lt; &amp;obj &lt;&lt; endl;            <span class="comment">// 0</span></span><br><span class="line">        </span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.x1: &quot;</span> &lt;&lt; &amp;obj.x1 &lt;&lt; endl;   <span class="comment">// 8</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.x2: &quot;</span> &lt;&lt; &amp;obj.x2 &lt;&lt; endl;   <span class="comment">// 12</span></span><br><span class="line">        <span class="comment">// 接下来是16 x3</span></span><br><span class="line">        <span class="comment">// cout &lt;&lt; &quot;&amp;obj.y1: &quot; &lt;&lt; &amp;obj.y1 &lt;&lt; endl;  </span></span><br><span class="line">        <span class="comment">// cout &lt;&lt; &quot;&amp;obj.y2: &quot; &lt;&lt; &amp;obj.y2 &lt;&lt; endl;</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.a: &quot;</span> &lt;&lt; &amp;obj.a &lt;&lt; endl;     <span class="comment">// 20</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.b: &quot;</span> &lt;&lt; (<span class="type">int</span> *)&amp;obj.b &lt;&lt; endl;  <span class="comment">// 24</span></span><br><span class="line">        </span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.c: &quot;</span> &lt;&lt; &amp;obj.c &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.d: &quot;</span> &lt;&lt; &amp;obj.d &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.e: &quot;</span> &lt;&lt; &amp;obj.e &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&amp;obj.f: &quot;</span> &lt;&lt; &amp;obj.f &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;sizeof obj: &quot;</span> &lt;&lt; <span class="keyword">sizeof</span> obj &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&amp;obj:   0x7ffc31b16580</span><br><span class="line">&amp;obj.x1: 0x7ffc31b16588</span><br><span class="line">&amp;obj.x2: 0x7ffc31b1658c</span><br><span class="line">&amp;obj.a: 0x7ffc31b16594</span><br><span class="line">&amp;obj.b: 0x7ffc31b16598</span><br><span class="line">&amp;obj.c: 0x7ffc31b165a0</span><br><span class="line">&amp;obj.d: 0x7ffc31b165a8</span><br><span class="line">&amp;obj.e: 0x7ffc31b165ac</span><br><span class="line">&amp;obj.f: 0x7ffc31b165b0</span><br><span class="line">sizeof obj: 56</span><br></pre></td></tr></table></figure>

<p>编译器在对象头部插入了虚指针，因此占用了8个字节。gdb查看obj对象头八个字节的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) set print object on  # 打印对象</span><br><span class="line">(gdb) set print pretty on  # 每行只会显示结构体的一名成员，而且还会根据成员的定义层次进行缩进</span><br><span class="line">(gdb) x /x &amp;obj</span><br><span class="line">0x7fffffffde20: 0x55557d30  # 虚指针的值</span><br><span class="line">(gdb) x /10x &amp;obj</span><br><span class="line">0x7fffffffde20: 0x55557d30      0x00005555      0xf7cc23a7      0x00007fff</span><br><span class="line">0x7fffffffde30: 0xf7e28e88      0x00007fff      0xf7e28e88      0x00007fff</span><br><span class="line">0x7fffffffde40: 0xf7e28e88      0x00007fff</span><br><span class="line">(gdb) info vtbl obj</span><br><span class="line">vtable for &#x27;Obj&#x27; @ 0x555555557d30 (subobject @ 0x7fffffffde20):</span><br><span class="line">[0]: 0x5555555552ba &lt;Base1::virtfunc1()&gt;</span><br><span class="line">(gdb) p obj</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">4 = (Obj) &#123;&lt;Base1&gt; = &#123;</span></span><br><span class="line">    _vptr.Base1 = 0x555555557d30 &lt;vtable for Obj+16&gt;, </span><br><span class="line">    x1 = -137616473, x2 = 32767, x3 = -136147320&#125;, a = 32767, </span><br><span class="line">  b = 136 &#x27;\210&#x27;, c = 6.9533490812636458e-310, </span><br><span class="line">  d = -8.64173507e+33, e = 32767, f = 140737352208216&#125;</span><br></pre></td></tr></table></figure>

<p>通过gdb查看对象内存分布的功能，可见编译器确实将虚指针存放在了对象开头八字节，虚指针指向虚表（并非表头，虚指针所指的位置前面还有信息），虚表中存放着虚函数的地址，而虚指针指向第一个虚函数的地址条目。</p>
<p>接下来，我们探究对象的虚表内容，编写如下代码，似的类的继承关系为Obj -&gt; Base2  -&gt; Base1，Base1和Base2均有各自的虚函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x1;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 1 virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> x2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span> : <span class="keyword">public</span> Base1</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> y1;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> y2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> y3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span> : <span class="keyword">public</span> Base2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Print</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">uint8_t</span> b;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">    <span class="type">float</span> d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">short</span> e;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">long</span> f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    obj.<span class="built_in">virtfunc1</span>();</span><br><span class="line">    obj.<span class="built_in">virtfunc2</span>();</span><br><span class="line">    Base2 b2 = obj;</span><br><span class="line">    b2.<span class="built_in">virtfunc2</span>();</span><br><span class="line">    Base1 b1 = b2;</span><br><span class="line">    b1.<span class="built_in">virtfunc1</span>();</span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;b1 &lt;&lt; endl;  <span class="comment">// base1 虚指针</span></span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;b2 &lt;&lt; endl;  <span class="comment">// base2 虚指针</span></span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;obj &lt;&lt; endl; <span class="comment">// obj虚指针</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过gdb查看三个类实例的虚表内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl b1</span><br><span class="line">vtable for &#x27;Base1&#x27; @ 0x555555557d30 (subobject @ 0x7fffffffddf0):</span><br><span class="line">[0]: 0x55555555550c &lt;Base1::virtfunc1()&gt;</span><br><span class="line">(gdb) info vtbl b2</span><br><span class="line">vtable for &#x27;Base2&#x27; @ 0x555555557d10 (subobject @ 0x7fffffffde10):</span><br><span class="line">[0]: 0x555555555538 &lt;Base2::virtfunc1()&gt;</span><br><span class="line">[1]: 0x555555555564 &lt;Base2::virtfunc2()&gt;</span><br><span class="line">(gdb) info vtbl obj</span><br><span class="line">vtable for &#x27;Obj&#x27; @ 0x555555557cf0 (subobject @ 0x7fffffffde30):</span><br><span class="line">[0]: 0x555555555590 &lt;Obj::virtfunc1()&gt;</span><br><span class="line">[1]: 0x5555555555bc &lt;Obj::virtfunc2()&gt;</span><br></pre></td></tr></table></figure>

<p>每个类都有自己的虚表，虚表中的条目包含虚函数的地址，对象调用虚函数时通过查找虚表中的条目而获得虚函数的地址。可以发现，obj中继承自父类的虚函数的地址与父类的虚函数地址均不相同，因为在这里，子类都重写了父类的虚函数。如obj重写了继承自Base2和Base1的虚函数，而Base2重写了继承自Base1的虚函数。</p>
<p>这也可以解释为什么指针和引用可以实现多态，即使指针是父类类型，但是如果其指向一个子类，则虚指针指向的是子类的虚表。并且，定义了虚函数的类，其默认构造函数和拷贝构造函数不是bit Semantics的，因为构造对象（默认或者拷贝）时，构造函数会设置对象的虚指针指向该对象类型的虚表。因此main函数中，通过赋值构造的b1和b2的虚指针指向的是Base1和Base2的虚表。</p>
<p>注释掉Base2对继承自Base1的虚函数的重写，以及Object对继承自Base2的虚函数的重写，我们猜测，虚表中的相应的虚函数条目应该和父类保持一致。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span> : <span class="keyword">public</span> Base1</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> y1;</span><br><span class="line">    <span class="comment">// virtual void virtfunc1()</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     cout &lt;&lt; &quot;Base 2 virtfunc1\n&quot;;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> y2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> y3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span> : <span class="keyword">public</span> Base2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Print</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">uint8_t</span> b;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// virtual void virtfunc2()</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     cout &lt;&lt; &quot;Obj virtfunc2\n&quot;;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">    <span class="type">float</span> d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">short</span> e;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">long</span> f;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl b1</span><br><span class="line">vtable for &#x27;Base1&#x27; @ 0x555555557d30 (subobject @ 0x7fffffffddf0):</span><br><span class="line">[0]: 0x55555555550e &lt;Base1::virtfunc1()&gt;</span><br><span class="line">(gdb) info vtbl b2</span><br><span class="line">vtable for &#x27;Base2&#x27; @ 0x555555557d10 (subobject @ 0x7fffffffde10):</span><br><span class="line">[0]: 0x55555555550e &lt;Base1::virtfunc1()&gt;</span><br><span class="line">[1]: 0x55555555553a &lt;Base2::virtfunc2()&gt;</span><br><span class="line">(gdb) info vtbl obj</span><br><span class="line">vtable for &#x27;Obj&#x27; @ 0x555555557cf0 (subobject @ 0x7fffffffde30):</span><br><span class="line">[0]: 0x555555555566 &lt;Obj::virtfunc1()&gt;</span><br><span class="line">[1]: 0x55555555553a &lt;Base2::virtfunc2()&gt;</span><br></pre></td></tr></table></figure>

<p>取消刚刚的注释，为Base1和Base2再添加一个虚函数，以及Obj类自己的虚函数，重新编译。同时，我们验证同类型的对象的虚指针是相同的，即程序只需要维护一份虚表（没必要为不同对象维护单独的一份虚表）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x1;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 1 virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 1 virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> x2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> x3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span> : <span class="keyword">public</span> Base1</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> y1;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc1 from Base 1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base2_virt2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc2 \n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> y2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> y3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span> : <span class="keyword">public</span> Base2</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">uint8_t</span> b;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj 1 virtfunc1 from base 1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base2_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj 1 virtfunc1 from base 2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">    <span class="type">float</span> d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">short</span> e;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">long</span> f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    Base2 b2 = obj;</span><br><span class="line">    Base1 b1 = obj;</span><br><span class="line">    Base1 b11;   <span class="comment">// 默认构造</span></span><br><span class="line">    Base2 b22 = b2;  <span class="comment">// 拷贝构造</span></span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;b1 &lt;&lt; endl;  <span class="comment">// base1 虚指针</span></span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;b11 &lt;&lt; endl; <span class="comment">// base1 虚指针</span></span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;b2 &lt;&lt; endl;  <span class="comment">// base2 虚指针</span></span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;b22 &lt;&lt; endl; <span class="comment">// base2 虚指针</span></span><br><span class="line">    cout &lt;&lt; hex &lt;&lt; *(<span class="type">uintptr_t</span> *)&amp;obj &lt;&lt; endl; <span class="comment">// obj虚指针</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gdb查看对象内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p b1</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = &#123;_vptr.Base1 = 0x555555557d28 &lt;vtable <span class="keyword">for</span> Base1+16&gt;, x1 = -136147320, x2 = 32767, x3 = -136147320&#125;</span></span><br><span class="line">(gdb) p b11</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;_vptr.Base1 = 0x555555557d28 &lt;vtable <span class="keyword">for</span> Base1+16&gt;, x1 = 0, x2 = 0, x3 = 0&#125;</span></span><br><span class="line">(gdb) p b2</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">3 = &#123;&lt;Base1&gt; = &#123;_vptr.Base1 = 0x555555557d00 &lt;vtable <span class="keyword">for</span> Base2+16&gt;, x1 = -136147320, x2 = 32767,</span> </span><br><span class="line">    x3 = -136147320&#125;, y1 = 32767, y2 = -137033468, y3 = 32767&#125;</span><br><span class="line">(gdb) p b22</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">4 = &#123;&lt;Base1&gt; = &#123;_vptr.Base1 = 0x555555557d00 &lt;vtable <span class="keyword">for</span> Base2+16&gt;, x1 = -136147320, x2 = 32767,</span> </span><br><span class="line">    x3 = -136147320&#125;, y1 = 32767, y2 = -137033468, y3 = 32767&#125;</span><br><span class="line">(gdb) p obj</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">5 = &#123;&lt;Base2&gt; = &#123;&lt;Base1&gt; = &#123;_vptr.Base1 = 0x555555557cc0 &lt;vtable <span class="keyword">for</span> Obj+16&gt;, x1 = -136147320,</span> </span><br><span class="line">      x2 = 32767, x3 = -136147320&#125;, y1 = 32767, y2 = -137033468, y3 = 32767&#125;, a = -136147112, </span><br><span class="line">  b = 255 &#x27;\377&#x27;, c = 6.9533490273497203e-310, d = -9.19059065e+33, e = 32767, f = 140737352208008&#125;</span><br></pre></td></tr></table></figure>

<p>b11和b1都是Base1对象，虚指针相同，而通过拷贝构造b2得到的b22，两个对象的虚指针也是一样的。但是我们可以发现，虚指针的值，并不是指向虚表开头，而是vtable+16。可见虚指针所指的位置前面还有16字节的内容。</p>
<p>接下来探究虚表中的内容。</p>
<p>查看Obj类对象的虚表前十六字节：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl obj</span><br><span class="line">vtable for &#x27;Obj&#x27; @ 0x555555557cc0 (subobject @ 0x7fffffffe430):</span><br><span class="line">[0]: 0x55555555563a &lt;Obj::base1_virt1()&gt;</span><br><span class="line">[1]: 0x5555555555b6 &lt;Base1::base1_virt2()&gt;</span><br><span class="line">[2]: 0x55555555560e &lt;Base2::base2_virt2()&gt;</span><br><span class="line">[3]: 0x555555555666 &lt;Obj::base2_virt1()&gt;</span><br><span class="line">[4]: 0x555555555692 &lt;Obj::virtfunc1()&gt;</span><br><span class="line">[5]: 0x5555555556be &lt;Obj::virtfunc2()&gt;</span><br><span class="line">(gdb) x /12x 0x555555557cc0</span><br><span class="line">0x555555557cc0 &lt;_ZTV3Obj+16&gt;:   0x5555563a      0x00005555      0x555555b6      0x00005555</span><br><span class="line">0x555555557cd0 &lt;_ZTV3Obj+32&gt;:   0x5555560e      0x00005555      0x55555666      0x00005555</span><br><span class="line">0x555555557ce0 &lt;_ZTV3Obj+48&gt;:   0x55555692      0x00005555      0x555556be      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557cc0-16 # 虚表开头16字节内容</span><br><span class="line">0x555555557cb0 &lt;_ZTV3Obj&gt;:      0x00000000      0x00000000      0x55557d38      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d38   # 第二个64-bit字的内容</span><br><span class="line">0x555555557d38 &lt;_ZTI3Obj&gt;:      0xf7e1dc30      0x00007fff      0x555560b1      0x00005555</span><br></pre></td></tr></table></figure>

<p>虚指针所指处开始，每个条目为一个64-bit字，存储虚函数的地址。</p>
<p>通过c++filt命令查看de_mangle后的名字：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">c++filt _ZTI3Obj</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">typeinfo <span class="keyword">for</span> Obj</span></span><br></pre></td></tr></table></figure>

<p>可见，第一个字是0，第二个字存了一个地址，保存着对象类型的信息。使用指针和引用时，我们可以通过其所指向的或所引用的对象的虚指针，找到对象的虚表，进而找到对象的类型信息，从而得知这个对象是父类对象还是子类对象，c++的多态机制应该也是通过这种方式实现的。</p>
<p>查看Base1对象的虚表：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl b1</span><br><span class="line">vtable for &#x27;Base1&#x27; @ 0x555555557d28 (subobject @ 0x7fffffffe3b0):</span><br><span class="line">[0]: 0x55555555558a &lt;Base1::base1_virt1()&gt;</span><br><span class="line">[1]: 0x5555555555b6 &lt;Base1::base1_virt2()&gt;</span><br><span class="line">(gdb) x /4x 0x555555557d28</span><br><span class="line">0x555555557d28 &lt;_ZTV5Base1+16&gt;: 0x5555558a      0x00005555      0x555555b6      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d28-16   # 虚表开头16字节内容</span><br><span class="line">0x555555557d18 &lt;_ZTV5Base1&gt;:    0x00000000      0x00000000      0x55557d68      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d68      # 第二个64-bit字的内容</span><br><span class="line">0x555555557d68 &lt;_ZTI5Base1&gt;:    0xf7e1cfa0      0x00007fff      0x555560bd      0x00005555</span><br></pre></td></tr></table></figure>

<p>c++filt查看_ZIT5Base1：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">c++filt _ZTI5Base1</span></span><br><span class="line">typeinfo for Base1</span><br></pre></td></tr></table></figure>

<p>查看Base2对象的虚表：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl b2</span><br><span class="line">vtable for &#x27;Base2&#x27; @ 0x555555557d00 (subobject @ 0x7fffffffe3f0):</span><br><span class="line">[0]: 0x5555555555e2 &lt;Base2::base1_virt1()&gt;</span><br><span class="line">[1]: 0x5555555555b6 &lt;Base1::base1_virt2()&gt;</span><br><span class="line">[2]: 0x55555555560e &lt;Base2::base2_virt2()&gt;</span><br><span class="line">(gdb) x /4x 0x555555557d00</span><br><span class="line">0x555555557d00 &lt;_ZTV5Base2+16&gt;: 0x555555e2      0x00005555      0x555555b6      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d00-16  # 虚表开头16字节内容</span><br><span class="line">0x555555557cf0 &lt;_ZTV5Base2&gt;:    0x00000000      0x00000000      0x55557d50      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d50     # 第二个64-bit字的内容</span><br><span class="line">0x555555557d50 &lt;_ZTI5Base2&gt;:    0xf7e1dc30      0x00007fff      0x555560b6      0x00005555</span><br></pre></td></tr></table></figure>

<p>c++filt查看_ZIT5Base2：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">c++filt _ZTI5Base2</span></span><br><span class="line">typeinfo for Base2</span><br></pre></td></tr></table></figure>

<p>我们可以将上述结论抽象为如下的图例：</p>
<p>Base1对象布局：</p>
<p><img src="C:\Users\20550\AppData\Roaming\Typora\typora-user-images\image-20231108201212879.png" alt="image-20231108201212879"></p>
<p>Base2对象布局：</p>
<p><img src="C:\Users\20550\AppData\Roaming\Typora\typora-user-images\image-20231108201248944.png" alt="image-20231108201248944"></p>
<p>Obj对象布局：</p>
<p><img src="C:\Users\20550\AppData\Roaming\Typora\typora-user-images\image-20231108201300556.png" alt="image-20231108201300556"></p>
<h2 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h2><p>将上述程序修改为，Obj继承自Base1和Base2：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x1&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 1 virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 1 virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> x2&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> x3&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> y1;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base2_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc1 \n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base2_virt2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc2 \n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> y2;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> y3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span> : <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">uint8_t</span> b;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; hex &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; Obj 1 virtfunc1 from base 1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base2_virt1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; hex &lt;&lt; <span class="keyword">this</span> &lt;&lt;<span class="string">&quot; Obj 1 virtfunc1 from base 2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">    <span class="type">float</span> d;</span><br><span class="line">    <span class="type">short</span> e;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    Base1 b1;</span><br><span class="line">    Base2 b2;</span><br><span class="line">    obj.<span class="built_in">base1_virt1</span>();</span><br><span class="line">    obj.<span class="built_in">base2_virt1</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看三个类对象的布局：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p obj</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = &#123;</span></span><br><span class="line">  &lt;Base1&gt; = &#123;        # Base1父类的数据成员以及一个虚指针</span><br><span class="line">    _vptr.Base1 = 0x555555557ca8 &lt;vtable for Obj+16&gt;,</span><br><span class="line">    x1 = 0,</span><br><span class="line">    x2 = 0,</span><br><span class="line">    x3 = 0</span><br><span class="line">  &#125;, </span><br><span class="line">  &lt;Base2&gt; = &#123;    # Base2父类的数据成员以及一个虚指针</span><br><span class="line">    _vptr.Base2 = 0x555555557ce0 &lt;vtable for Obj+72&gt;,</span><br><span class="line">    y1 = -136147320,</span><br><span class="line">    y2 = 32767,</span><br><span class="line">    y3 = -137033468</span><br><span class="line">  &#125;,    # 子类自己的数据成员</span><br><span class="line">  members of Obj:</span><br><span class="line">  a = 32767,</span><br><span class="line">  b = 88 &#x27;X&#x27;,</span><br><span class="line">  c = 6.9533490273497203e-310,</span><br><span class="line">  d = -9.19059065e+33,</span><br><span class="line">  e = 32767,</span><br><span class="line">  f = 140737352208008</span><br><span class="line">&#125;</span><br><span class="line">(gdb) p b1</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  _vptr.Base1 = 0x555555557d20 &lt;vtable for Base1+16&gt;,</span><br><span class="line">  x1 = 0,</span><br><span class="line">  x2 = 0,</span><br><span class="line">  x3 = 0</span><br><span class="line">&#125;</span><br><span class="line">(gdb) p b2</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">3 = &#123;</span></span><br><span class="line">  _vptr.Base2 = 0x555555557d00 &lt;vtable for Base2+16&gt;,</span><br><span class="line">  y1 = 0,</span><br><span class="line">  y2 = 0,</span><br><span class="line">  y3 = 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难发现，在子类中，父类的数据成员按照声明的顺序排列，并且每个父类子对象都包含一个虚指针。我们可以认为，子类包含每个父类完整的子对象。三个类各自的虚表都不相同，因为虚表中存放的虚函数地址都是与类相关的。</p>
<p>查看Base1对象的虚表内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl b1</span><br><span class="line">vtable for &#x27;Base1&#x27; @ 0x555555557d20 (subobject @ 0x7fffffffdd90):</span><br><span class="line">[0]: 0x555555555420 &lt;Base1::base1_virt1()&gt;</span><br><span class="line">[1]: 0x55555555544c &lt;Base1::base1_virt2()&gt;</span><br><span class="line">(gdb) x /4x 0x555555557d20-16   # Offset						pointer to typeinfo</span><br><span class="line">0x555555557d10 &lt;_ZTV5Base1&gt;:    0x00000000      0x00000000      0x55557d78      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d78</span><br><span class="line">0x555555557d78 &lt;_ZTI5Base1&gt;:    0xf7e1cfa0      0x00007fff      0x555560b2      0x00005555</span><br></pre></td></tr></table></figure>

<p>与上一节讨论的情况相同，b1的虚表中包含Base1的虚函数地址，以及一个偏移值（0）和一个指向类类型信息的指针。</p>
<p>同理，Base2对象的虚表内容也是一样的布局：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl b2</span><br><span class="line">vtable for &#x27;Base2&#x27; @ 0x555555557d00 (subobject @ 0x7fffffffddb0):</span><br><span class="line">[0]: 0x555555555478 &lt;Base2::base2_virt1()&gt;</span><br><span class="line">[1]: 0x5555555554a4 &lt;Base2::base2_virt2()&gt;</span><br><span class="line">(gdb) x /4x 0x555555557d00</span><br><span class="line">0x555555557d00 &lt;_ZTV5Base2+16&gt;: 0x55555478      0x00005555      0x555554a4      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d00-16</span><br><span class="line">0x555555557cf0 &lt;_ZTV5Base2&gt;:    0x00000000      0x00000000      0x55557d68      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d68</span><br><span class="line">0x555555557d68 &lt;_ZTI5Base2&gt;:    0xf7e1cfa0      0x00007fff      0x555560ab      0x00005555</span><br></pre></td></tr></table></figure>

<p>我们重点查看Obj类在多重继承的情况下，虚表的布局情况：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl obj</span><br><span class="line">vtable for &#x27;Obj&#x27; @ 0x555555557ca8 (subobject @ 0x7fffffffddd0):</span><br><span class="line">[0]: 0x5555555554d0 &lt;Obj::base1_virt1()&gt;</span><br><span class="line">[1]: 0x55555555544c &lt;Base1::base1_virt2()&gt;</span><br><span class="line">[2]: 0x555555555524 &lt;Obj::base2_virt1()&gt;</span><br><span class="line">[3]: 0x555555555582 &lt;Obj::virtfunc1()&gt;</span><br><span class="line">[4]: 0x5555555555ae &lt;Obj::virtfunc2()&gt;</span><br><span class="line"></span><br><span class="line">vtable for &#x27;Base2&#x27; @ 0x555555557ce0 (subobject @ 0x7fffffffdde8):</span><br><span class="line">[0]: 0x555555555577 &lt;non-virtual thunk to Obj::base2_virt1()&gt;</span><br><span class="line">[1]: 0x5555555554a4 &lt;Base2::base2_virt2()&gt;</span><br></pre></td></tr></table></figure>

<p>obj中包含两个虚指针。这实际上也是为多态机制服务的。在c++中，父类指针和子类指针都可以指向一个子类对象。严格来说，父类指针指向的是子类对象中的父类子对象。</p>
<p>修改main函数，验证上述说法：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    Base1 b1;</span><br><span class="line">    Base2 b2;</span><br><span class="line">    Obj * p1 = &amp;obj;</span><br><span class="line">    Base1 * pb1 = &amp;obj;</span><br><span class="line">    Base2 * pb2 = &amp;obj;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Obj *   -&gt; obj: &quot;</span> &lt;&lt; hex &lt;&lt; p1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Base1 * -&gt; obj: &quot;</span> &lt;&lt; hex &lt;&lt; pb1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Base2 * -&gt; obj: &quot;</span> &lt;&lt; hex &lt;&lt; pb2 &lt;&lt; endl;</span><br><span class="line">    pb1 = p1;</span><br><span class="line">    pb2 = p1;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Obj *   -&gt; obj: &quot;</span> &lt;&lt; hex &lt;&lt; p1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Base1 * -&gt; obj: &quot;</span> &lt;&lt; hex &lt;&lt; pb1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Base2 * -&gt; obj: &quot;</span> &lt;&lt; hex &lt;&lt; pb2 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">./test</span></span><br><span class="line">Obj *   -&gt; obj: 0x7ffdc3d28750</span><br><span class="line">Base1 * -&gt; obj: 0x7ffdc3d28750</span><br><span class="line">Base2 * -&gt; obj: 0x7ffdc3d28768  # ?? 指向同一对象但是值不同</span><br><span class="line">Obj *   -&gt; obj: 0x7ffdc3d28750</span><br><span class="line">Base1 * -&gt; obj: 0x7ffdc3d28750</span><br><span class="line">Base2 * -&gt; obj: 0x7ffdc3d28768 # ?? 直接将p1赋值到pb2也是相同结果</span><br></pre></td></tr></table></figure>

<p>这是因为，c++编译器为我们做了调整，因为子类对象，我们也可以将它当成一个父类对象，子类对象包含父类对象的内容，即子类对象中的父类子对象。Obj类型的对象布局如下所示，首先是Base1的子对象，其次是Base2的子对象：</p>
<p><img src="C:\Users\20550\AppData\Roaming\Typora\typora-user-images\image-20231110195844016.png" alt="image-20231110195844016"></p>
<p>当指向Base2对象的指针实际上指向的是Obj类型对象时，编译器将其调整为指向obj对象的Base2子对象。这样当我们通过Base2指针操作Obj对象中的Base2类的数据成员时，各成员的偏移是不需要更改的。</p>
<p>接下来探究obj对象中的两个虚指针所指向的虚表的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl obj</span><br><span class="line">vtable for &#x27;Obj&#x27; @ 0x555555557ca8 (subobject @ 0x7fffffffddd0):</span><br><span class="line">[0]: 0x5555555554d0 &lt;Obj::base1_virt1()&gt;</span><br><span class="line">[1]: 0x55555555544c &lt;Base1::base1_virt2()&gt;</span><br><span class="line">[2]: 0x555555555524 &lt;Obj::base2_virt1()&gt;</span><br><span class="line">[3]: 0x555555555582 &lt;Obj::virtfunc1()&gt;</span><br><span class="line">[4]: 0x5555555555ae &lt;Obj::virtfunc2()&gt;</span><br><span class="line"></span><br><span class="line">vtable for &#x27;Base2&#x27; @ 0x555555557ce0 (subobject @ 0x7fffffffdde8):</span><br><span class="line">[0]: 0x555555555577 &lt;non-virtual thunk to Obj::base2_virt1()&gt;</span><br><span class="line">[1]: 0x5555555554a4 &lt;Base2::base2_virt2()&gt;</span><br></pre></td></tr></table></figure>

<p>打印obj的对象布局时，可以看到关于虚指针的描述信息：**_vptr.Base1 &#x3D; 0x555555557ca8 &lt;vtable for Obj+16&gt;<strong>和</strong>_vptr.Base2 &#x3D; 0x555555557ce0 &lt;vtable for Obj+72&gt;**，这两个指针相差也确实是56字节，因此两个指针应该指向的是Obj类的虚表中的不同位置。回顾一下，单继承的多态下，对象头部八字节存放虚指针，指向虚表的第16字节处，虚表的前16字节包括一个8字节的偏移量（一般为0）以及一个指向类型信息的指针，然后是虚函数地址条目。</p>
<p>此处_vptr.Base1所指向的仍然是虚表的第16字节，而_vptr.Base2所指为虚表的第72字节。从第16字节到第72字节，包含5个虚函数条目，分别有Obj类继承自Base1的2个虚函数，重写Base2的一个虚函数，以及自身定义的两个虚函数。5个条目共占40字节。还剩下16字节，应该包含的是一个偏移量以及一个指向类型信息的指针。</p>
<p>通过gdb查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x /4x 0x555555557ca8-16</span><br><span class="line">0x555555557c98 &lt;_ZTV3Obj&gt;:      0x00000000      0x00000000      0x55557d30      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557ce0-16</span><br><span class="line">0x555555557cd0 &lt;_ZTV3Obj+56&gt;:   0xffffffe8      0xffffffff      0x55557d30      0x00005555</span><br><span class="line">(gdb) x /4x 0x555555557d30</span><br><span class="line">0x555555557d30 &lt;_ZTI3Obj&gt;:      0xf7e1dcf0      0x00007fff      0x555560a6      0x00005555</span><br></pre></td></tr></table></figure>

<p>可见，第一个虚指针前16字节为偏移量0和指向obj类型信息的指针，而第二个虚指针前16字节为偏移量-24和指向obj类型信息的指针。因此Obj类的虚表其实相当于组合了两个父类的虚表，子类和第一个声明的父类共用第一个虚表（因为第一个声明的父类子对象就在子类对象的最前端），后续声明的父类的虚表相继排列在后面。第一个也称之为“主虚表”（primary virtual table），后续的虚表又称之为“次虚表”（secondary virtual table）。一个含有虚函数（无论是其本身的，还是继承而来的）的类，可以有一个主虚表和多个次虚表，主虚表和次虚表构成一个虚表组（virtual table group）。</p>
<p>现在我们可以完善Obj类型对象的布局图：</p>
<p><img src="C:\Users\20550\AppData\Roaming\Typora\typora-user-images\image-20231110202652872.png" alt="image-20231110202652872"></p>
<p>为了支持多态，编译器使用虚指针前面的16字节存储两个信息：</p>
<ul>
<li>偏移量：当前父类子对象到该对象起始处的偏移，称其为<strong>top_offset</strong>。</li>
<li>类型信息指针：指向当前对象的类型信息，每个父类子对象的虚指针前8字节都指向同一个类型信息。</li>
</ul>
<p>对于虚表中虚函数条目的排列顺序，在主虚函数表中，将父类的虚函数条目按序排列，如果子类重写了该虚函数，则条目设置为子类的虚函数地址，子类自定义的新的虚函数条目按序排在后面。</p>
<p>对于从虚表，按照父类的虚函数条目顺序排列，子类重写的虚函数则对应条目需要重新设置。不同于主表中直接设置为子类虚函数的地址，而是设置为<strong>指向一个子类虚函数的non-virtual thunk</strong>。</p>
<p>gdb查看non-virtual thunk的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl obj</span><br><span class="line">vtable for &#x27;Obj&#x27; @ 0x555555557ca8 (subobject @ 0x7fffffffde20):</span><br><span class="line">[0]: 0x5555555554d0 &lt;Obj::base1_virt1()&gt;</span><br><span class="line">[1]: 0x55555555544c &lt;Base1::base1_virt2()&gt;</span><br><span class="line">[2]: 0x555555555524 &lt;Obj::base2_virt1()&gt;</span><br><span class="line">[3]: 0x555555555582 &lt;Obj::virtfunc1()&gt;</span><br><span class="line">[4]: 0x5555555555ae &lt;Obj::virtfunc2()&gt;</span><br><span class="line"></span><br><span class="line">vtable for &#x27;Base2&#x27; @ 0x555555557ce0 (subobject @ 0x7fffffffde38):</span><br><span class="line">[0]: 0x555555555577 &lt;non-virtual thunk to Obj::base2_virt1()&gt;</span><br><span class="line">[1]: 0x5555555554a4 &lt;Base2::base2_virt2()&gt;</span><br><span class="line">(gdb) x /10i 0x555555555577</span><br><span class="line">   0x555555555577 &lt;_ZThn24_N3Obj11base2_virt1Ev&gt;:       endbr64 </span><br><span class="line">   0x55555555557b &lt;_ZThn24_N3Obj11base2_virt1Ev+4&gt;:     sub    $0x18,%rdi    # %rdi存储第一个参数 this指针，此处调整this指针指向子类对象</span><br><span class="line">   0x55555555557f &lt;_ZThn24_N3Obj11base2_virt1Ev+8&gt;:     jmp    0x555555555524 &lt;_ZN3Obj11base2_virt1Ev&gt; # 调用子类虚函数</span><br><span class="line">   0x555555555581:      nop</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>可见，<strong>non-virtual thunk</strong>是编译器根据top_offset，编写的一小段代码，调整指向父类子对象的指针指向子类对象，以便于调用子类虚函数时，this指针是指向当前对象的。</p>
<h2 id="虚拟继承"><a href="#虚拟继承" class="headerlink" title="虚拟继承"></a>虚拟继承</h2><p>精简每个类的数据成员，添加一个Base基类，探究虚拟继承下的对象布局和虚表结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base_virt</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base virtfunc\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base1</span>: <span class="keyword">virtual</span> <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x1&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base1_virt</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 1 virtfunc\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base2</span>: <span class="keyword">virtual</span> <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x2;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">base2_virt</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Base 2 virtfunc \n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obj</span> : <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> y&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc1\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">virtfunc2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Obj virtfunc2\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    Base1 b1;</span><br><span class="line">    Base2 b2;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://neutron-l.github.io/2023/02/10/object_layout/" data-id="clf8621ru0003a0u3ei3uf7ke" data-title="c++对象布局" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cpp/" rel="tag">Cpp</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/02/20/rtti/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          RTTI
        
      </div>
    </a>
  
  
    <a href="/2023/02/09/copy_control/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">copy control</div>
    </a>
  
</nav>

  
</article>


</section>
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Concurrency/" rel="tag">Concurrency</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp/" rel="tag">Cpp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp-Effective/" rel="tag">Cpp Effective</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp-STL/" rel="tag">Cpp STL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp-%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B/" rel="tag">Cpp 对象模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cache/" rel="tag">cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode-graph/" rel="tag">leetcode graph</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode-string/" rel="tag">leetcode string</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" rel="tag">操作系统 汇编语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/02/27/rte_hash/">DPDK Hash</a>
          </li>
        
          <li>
            <a href="/2024/02/26/DPDK%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B8%8E%E4%BC%98%E5%8C%96/">DPDK memory management</a>
          </li>
        
          <li>
            <a href="/2023/05/15/spin_lock/">自旋锁</a>
          </li>
        
          <li>
            <a href="/2023/04/29/ast/">抽象语法树</a>
          </li>
        
          <li>
            <a href="/2023/04/06/mempool/">Mempool</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Computer-System/">Computer System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tool/">Tool</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/dpdk/">dpdk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/language/">language</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li></ul>
    </div>
  </div>

  
</aside>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 By Autoload<br>
      Driven - <a href="https://hexo.io/" target="_blank">Hexo</a>|Theme - <a href="https://github.com/autoload/hexo-theme-auto" target="_blank">Auto</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/script.js"></script>




  </div>
</body>
</html>